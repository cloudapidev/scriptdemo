<?phprequire_once 'venders/limonade.php';require_once 'cloudapi/cloudapi.class.php';require_once 'curl/curl.class.php';$apptoken="a91r5k7jhq17dzykzu4i66z86m00q62da3s8meteyr637fq6618q20fo3jk9643cwu491w20p42bqy5txufyu76w";$apiroot="http://58.185.157.58:8000";function getsession_tag() {  $json = file_get_contents("php://input");  if(empty($json)) {    return "";  }  $session = json_decode($json);  if (!is_object($session) || !property_exists($session, "session")) {    return "";  }  if (!is_object($session->session) || !property_exists($session->session, "tag")) {    return "";  }  return $session->session->tag;}$cloudapi = new Cloudapi();dispatch_post('/', 'entry');function entry(){	global $cloudapi;	global $apptoken;	global $apiroot;	try {		$cloudapiResult = new Result();  //电话后续控制交互		select();	} catch (Exception $e) {		$cloudapiSession = new Session(); //电话第一次打入的session		$cloudapi->cloudlog("qqgetsession_tag" . getsession_tag());		$cloudapi->cloudlog("qqgetFrom" . $cloudapiSession->getTo()->id);		if(getsession_tag() === "this_is_a_reject_and_callback_service") {			menu();		} elseif(getsession_tag() === "this_is_outcall_for_advertise") {			$params = array('name'=>'advertise_playing','voice'=>'en','timeout'=>30.0,'attempts'=>3,'mode'=>'dtmf','interdigitTimeout'=>5,'terminator'=>'#','choices'=>'[1-6 DIGITS]');			$cloudapi->ask("Melatonin, the last five boxes,reservations,please press one",$params);			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		} elseif($cloudapiSession->getTo()->id === "6531520067") {			$UserNumber = $cloudapiSession->getFrom()->id;			$curl = new mycurl($apiroot . "/v1/token_fire/out_call?app_number=" . $cloudapiSession->getTo()->id . "&call_to_number=" . $UserNumber . "&tag=this_is_a_reject_and_callback_service");			$curl->setToken($apptoken);			$curl->setContentType("application/json; charset=utf-8");			$curl->createCurl();			$cloudapiSession->reject();			$cloudapi->renderJSON();		} else {			menu();		}	}   }function menu(){	global $cloudapi;	$cloudapi->cloudlog("this is cloudlog test");  $params = array('name'=>'service','voice'=>'en','timeout'=>30.0,'attempts'=>3,'mode'=>'dtmf','interdigitTimeout'=>5,'terminator'=>'#','choices'=>'[1-6 DIGITS]');  $cloudapi->ask("Please choose the number to test function:joining conference ,press one;transfering ,press two,sending message ,press three;recording ,press four;hanging up ,press five;calling out and playing a advertisement,press six;playing a audio,press seven",$params);  //,  $cloudapi->on(array('event'=>'continue','next'=>''));	$cloudapi->on(array('event'=>'hangup','next'=>''));	$cloudapi->renderJSON();  //生成控制命令}function select(){	global $cloudapi;	global $apptoken;	global $apiroot;	$cloudapiResult = new Result();	$actions = $cloudapiResult->getActions();	$replyInput = "*";	if (!isset($actions)){		menu();	} else {		foreach ($actions as $action){			if($action->name === "service") {				menu_main($action->value);			}elseif($action->name === "sms") {				$cloudapi->say("you sms have send",array('name'=>'smssay'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "ask8") {				$cloudapi->say("now you are in same file menu",array('name'=>'smssay'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "recordby7") {				$cloudapi->say("record file done",array('name'=>'smssay'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "dtmftransfer") {				$cloudapi->say("record file done",array('name'=>'smssay'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "askconfnumber") {				$cloudapi->say("The  number which you will enter the conference meeting is:" . $action->value,array('voice'=>'en'));				$cloudapi->conference($action->value,array('name'=>'conference'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "asktransfernumber") {				$cloudapi->say("You will be transferred to:" . $action->value,array('voice'=>'en'));				$cloudapi->transfer("tel:" . $action->value,array('name'=>'dotransfer','early_media'=>'/root/ringmedia/apple.mp3','timeout'=>40.0));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "dotransfer") {				$cloudapi->say("Calling forwarding ends, return to the main menu",array('voice'=>'en'));				menu();			}elseif($action->name === "askcallnumber") {				$cloudapi->say("The outgoing and advertising to number:" . $action->value,array('voice'=>'en'));				$cloudapi->call($action->value,array('from'=>"6531520093",'name'=>'docall','timeout'=>40.0,'say'=>"This is a chapter from 10,086 Chinese advertisement",'voice'=>'en'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));                $cloudapi->renderJSON();							//	$curl = new mycurl($apiroot . "/v1/token_fire/out_call?app_number=6531520069&call_to_number=" . $action->value . "&tag=this_is_outcall_for_advertise");			//	$curl->setToken($apptoken);			//	$curl->setContentType("application/json; charset=utf-8");			//	$curl->createCurl();			//	$cloudapi->cloudlog($curl->__tostring());			//	$cloudapi->renderJSON();			}elseif($action->name === "advertise_playing") {				$cloudapi->say("you are being transferred to your sales staff",array('voice'=>'en'));				$cloudapi->transfer("tel:861010086" . $action->value,array('name'=>'advertise_to_operator','timeout'=>40.0));				$cloudapi->renderJSON();			}elseif($action->name === "docall") {				$cloudapi->say("Advertising ends and return to the main menu",array('voice'=>'en'));				menu();			}elseif($action->name === "asksmsnumber") {				$cloudapi->say("sending message to ：" . $action->value, array('voice'=>'en'));				$cloudapi->message("somebody try send sms to you with中文",array('name'=>'sms','to'=>$action->value,'from'=>'6582400886'));				$cloudapi->on(array('event'=>'continue','next'=>''));				$cloudapi->on(array('event'=>'hangup','next'=>''));				$cloudapi->renderJSON();			}elseif($action->name === "dorecord") {				$cloudapi->say("Recording ends,you can play the audio  on  the cloud Homepage audio files, now return to the main menu:" . $action->value, array('voice'=>'en'));				menu();			}else {				//menu();			}		}	}}function menu_main($replyInput) {	global $cloudapi;		if ("#"===$replyInput){		}elseif ("1"===$replyInput){			$cloudapi->ask("Please enter the three-digit room number.",array('name'=>'askconfnumber','voice'=>'en','choices'=>'[3 DIGITS]'));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("2"===$replyInput){			$cloudapi->ask("Please enter the call forwarding number with country code",array('name'=>'asktransfernumber','voice'=>'en','choices'=>'[8-13 DIGITS]','timeout'=>30.0));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("3"===$replyInput){			$cloudapi->ask("Please enter the phone number which receives the message  with country code",array('name'=>'asksmsnumber','voice'=>'en','choices'=>'[8-13 DIGITS]','timeout'=>30.0));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("4"===$replyInput){			$cloudapi->say("starting recording,press the any keys to exit" . $action->value, array('voice'=>'en'));			$cloudapi->record("",array('name'=>'dorecord','to'=>'8613980616143','from'=>'6582400886'));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("5"===$replyInput){			$cloudapi->say("some phones will be hung up", array('voice'=>'en'));			$cloudapi->hangup();			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("6"===$replyInput){			$cloudapi->ask("Please enter the target phone  number with country code",array('name'=>'askcallnumber','voice'=>'en','choices'=>'[8-13 DIGITS]','timeout'=>30.0));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("7"===$replyInput){			$cloudapi->say("playing a audio after five seconds  silence,and hanging up", array('voice'=>'en'));			$cloudapi->wait(array('milliseconds'=>5000));			$cloudapi->say("End of silence and  hang up", array('voice'=>'en'));			$cloudapi->renderJSON();		}elseif ("8"===$replyInput){			$cloudapi->ask("test menu item in same file",array('name'=>'ask8','choices'=>'[1-6 DIGITS]'));			$cloudapi->on(array('event'=>'continue','next'=>''));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		}elseif ("0"===$replyInput){			$cloudapi->ask("Press any key to jump to full-function conference system",array('voice'=>'en','choices'=>'[1-1 DIGITS]','timeout'=>30.0));			$cloudapi->on(array('event'=>'continue','next'=>'http://devcloudapi.gnum.com:8181/GRCloudAPIApp/conference/main'));			$cloudapi->on(array('event'=>'hangup','next'=>''));			$cloudapi->renderJSON();		} else {			//所有命令的例子		//	$cloudapi->say("you sms have send",array('name'=>'askcallnumber','voice'=>'en'));		//	$cloudapi->wait(array('milliseconds'=>5000));		//	$cloudapi->hangup();		//	$cloudapi->reject();		//	$cloudapi->redirect();  //还有一些问题		//	$cloudapi->record(array('name'=>'recordby7','timeout'=>'300','max_length'=>'3600'));		//	$cloudapi->transfer("tel:8613980616143",array('name'=>'transfer','timeout'=>30.0));		//	$cloudapi->conference("8888",array('name'=>'conference'));		//	$cloudapi->ask("Please select test number and terminate with #.",array('name'=>'service','voice'=>'en','choices'=>'[1-6 DIGITS]','timeout'=>30.0,'attempts'=>3)); //time是放音开始就计时, choices是必填字段		//	$cloudapi->cloudlog("this is cloudlog test");		//	$cloudapi->call("tel:8613980616143",array('name'=>'call'));		//	$cloudapi->on(array('event'=>'continue','next'=>'/other.php'));		//	$cloudapi->on(array('event'=>'continue','next'=>''));  //next = '' mean still use self		}}run();?>